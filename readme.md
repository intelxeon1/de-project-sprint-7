Для сохранения результатов расчета в целевой папке витрин /user/username/data/analytics предлагается создать три типа каталога-витрины:
    "users" - для витрин с пользователями
    "zones" - для витрины с аналитикой по зонам
    "recomendation" - для рекомендаций

Алгоритм принимает расчет опорную дату и глубину в прошлое, за которое происходит расчет. 
Таким образом, конечные витирны будут иметь вид
<mart>-date-depth, например, users-2022-01-01-10
    
Алгоритм в части анализа адреса пользователя учитывает все события, а нетолько сообщения.
Все события выстраиваются в хронологическом порядке, агрегируются до даты:
user datetime city

Далее для каждой строки вычисляется следующий город и строки, где следующий и текущий город одинаковые, удаляются:
user datetime city next_city next_date

Этим обеспечивается отсутствие дублей для цепочки городов, а также мы можем оценить сколько был человек в каждом городе.
Допущение, что человек переместился в другой город, в момент события в новом месте.